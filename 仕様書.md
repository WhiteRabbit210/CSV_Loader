# CSV読み込みによるユーザー管理システム仕様書

## 1. システム概要

本システムは、既存のSaaSシステムに対して、外部の人事・基幹システムからエクスポートされたCSVファイルを読み込み、ユーザー情報の同期を行うシステムです。

## 2. 現行システム構成

### 2.1 既存のユーザー情報
- **ID**: EntraIDから取得したObjectID または AWS Cognitoが発行したユニークID
- **メールアドレス**: ユーザーの一意識別子として使用
- **役職**: ユーザーの役職情報
- **所属**: ユーザーの所属部署情報

## 3. 機能要件

### 3.1 CSV読み込み機能
- 外部システムからエクスポートされたCSVファイルを読み込む
- 複数の顧客の異なるCSVフォーマットに対応

### 3.2 ユーザー同期機能

#### 3.2.1 データ更新
- **条件**: CSVのメールアドレスが既存のSaaSユーザーと一致
- **処理**: 該当ユーザーの役職・所属情報を更新

#### 3.2.2 新規ユーザー追加
- **条件**: CSVのメールアドレスがSaaSに存在しない
- **処理**: 
  - SaaSに新規ユーザーを追加
  - AWS Cognitoに新規ユーザーを作成

#### 3.2.3 ユーザー削除
- **条件**: SaaSに存在するがCSVに含まれないメールアドレス
- **処理**: 
  - SaaSからユーザーを削除
  - AWS Cognitoからユーザーを削除

### 3.3 フィールドマッピング機能

#### 3.3.1 自動解析機能
- CSVファイルのヘッダーを解析
- 各フィールドの内容を分析し、自動的にマッピング候補を提示
  - メールアドレスフィールドの特定
  - 役職フィールドの特定
  - 所属フィールドの特定

#### 3.3.2 手動マッピング機能
- ユーザーが手動でフィールドの割り当てを設定可能
- ドラッグ&ドロップまたはドロップダウンによる直感的な操作

#### 3.3.3 マッピング設定の保存・再利用
- マッピング設定の保存
  - JSON形式でマッピング情報を保存
  - 顧客/システムごとに複数のマッピング設定を管理
- マッピング設定の読み込み
  - 保存済みの設定一覧表示
  - 「前回の割り当て内容を利用」ボタンによる簡易適用

## 4. システム構成

### 4.1 技術スタック
- **バックエンド**: Python 3.9+ on AWS Lambda
  - CSV処理: pandas, csv
  - AWS連携: boto3（Cognito, DynamoDB, S3）
  - API: AWS API Gateway + Lambda
- **フロントエンド**: Vue.js 3
  - UI Framework: Vuetify 3 or Element Plus
  - 状態管理: Pinia
  - HTTP通信: Axios
- **認証連携**: AWS Cognito SDK (boto3)
- **データ保存**: 
  - DynamoDB（マッピング設定、処理履歴）
  - S3（一時的なCSVファイル保存）

### 4.2 データフロー
1. CSVファイルアップロード
2. CSVヘッダー解析・フィールド自動認識
3. マッピング設定（自動/手動/既存設定利用）
4. データ検証
5. 差分計算（追加/更新/削除）
6. 同期処理実行
7. 結果レポート生成

## 5. UI要件

### 5.1 CSVアップロード画面
- ファイル選択/ドラッグ&ドロップ対応
- CSVプレビュー機能（先頭10行程度）

### 5.2 フィールドマッピング画面
- CSVカラム一覧表示
- システムフィールドへのマッピング設定
- 保存済み設定の選択オプション
- マッピング結果のプレビュー

### 5.3 同期確認画面
- 処理予定の表示
  - 新規追加ユーザー一覧
  - 更新対象ユーザー一覧
  - 削除対象ユーザー一覧
- 実行確認ボタン

### 5.4 処理結果画面
- 処理結果サマリー
- エラー詳細（あれば）
- 処理ログのダウンロード

## 6. セキュリティ要件

- CSVファイルの一時保存は暗号化
- 処理完了後の自動削除
- 操作ログの記録
- 権限管理（管理者のみ実行可能）

## 7. エラーハンドリング

### 7.1 想定されるエラー
- CSVフォーマット不正
- 必須フィールドの欠落
- メールアドレス形式エラー
- Cognito API エラー
- 重複メールアドレス

### 7.2 エラー処理
- トランザクション管理（部分的な更新を防ぐ）
- エラーログの詳細記録
- リトライ機能（Cognito API エラー時）

## 8. 拡張性考慮事項

- プラグイン形式での外部システム対応
- カスタムフィールドの追加対応
- バッチ処理/スケジュール実行機能
- API経由での連携機能

## 9. Lambda構成

### 9.1 Lambda関数分割
- **CSV解析Lambda**: CSVファイルの解析、フィールド自動認識
- **ユーザー同期Lambda**: 実際の同期処理（追加/更新/削除）
- **設定管理Lambda**: マッピング設定の保存/読み込み
- **レポート生成Lambda**: 処理結果レポートの生成

### 9.2 Lambda設定
- **ランタイム**: Python 3.9以上
- **メモリ**: 512MB～1GB（CSVサイズに応じて調整）
- **タイムアウト**: 5分（大量データ処理を考慮）
- **環境変数**:
  - COGNITO_USER_POOL_ID
  - DYNAMODB_TABLE_NAME
  - S3_BUCKET_NAME

### 9.3 API Gateway設定
- REST API または HTTP API
- CORS設定（Vueフロントエンドからのアクセス許可）
- 認証: Cognito User Pool Authorizer

## 10. Python実装の妥当性

Pythonバックエンドは以下の理由により適切です：

### 10.1 メリット
- **CSV処理**: pandas/csvモジュールによる効率的な処理
- **AWS SDK**: boto3による完全なAWSサービス統合
- **Lambda対応**: 軽量で高速な起動
- **豊富なライブラリ**: データ処理、文字エンコーディング対応

### 10.2 実装上の考慮点
- **パッケージサイズ**: Lambda Layerを使用してpandasなどの大きなライブラリを管理
- **メモリ管理**: 大量データ処理時のメモリ効率的な実装
- **非同期処理**: 大量ユーザー処理時はSQS/Step Functionsとの連携を検討